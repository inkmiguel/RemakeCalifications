<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-danger">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Evaluador</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbar">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link active" href="#">Inicio</a>
        </li>
      </ul>
      <div class="d-flex align-items-center">
        <span class="text-light me-3" *ngIf="usuarioLogueado && usuarioActual">
          <i class="bi bi-person-circle me-1"></i>
          Bienvenido, {{ usuarioActual.name }}
        </span>
        <button class="btn btn-outline-light" type="button" 
                (click)="usuarioLogueado ? logout() : irALogin()">
          <i class="bi" [ngClass]="usuarioLogueado ? 'bi-box-arrow-right' : 'bi-box-arrow-in-right'"></i>
          {{ usuarioLogueado ? 'Logout' : 'Login' }}
        </button>
      </div>
    </div>
  </div>
</nav>

<!-- Contenido -->
<div class="container mt-4">
  <div class="row">
    <!-- Lado Izquierdo: Formulario -->
    <div class="col-md-6">
      <div *ngIf="modoEdicion" class="alert alert-info mb-3">
        <i class="bi bi-pencil-square me-2"></i>
        <strong>Modo Edición:</strong> Editando evaluación de {{ evaluacionEditando?.nombre }} - {{ evaluacionEditando?.materia }}
      </div>
      
      <h3>Evaluación de Estudiante</h3>

      <div class="mb-3">
        <label for="correoAlumno">Correo del Estudiante</label>
        <div class="position-relative">
          <input type="email" id="correoAlumno" class="form-control" 
                 [(ngModel)]="correoAlumno" name="correoAlumno"
                 (input)="onCorreoInput($event)"
                 (blur)="buscarEstudiantePorCorreo(); ocultarSugerenciasEstudiantes()"
                 placeholder="Escribe el correo del estudiante..."
                 autocomplete="off">
          
          <!-- Dropdown de sugerencias de estudiantes -->
          <div class="dropdown-menu show position-absolute w-100" 
               *ngIf="mostrarSugerenciasEstudiantes && estudiantesFiltrados.length > 0 && usuarioActual?.tipoUsuario === 'profesor'"
               style="z-index: 1050; max-height: 200px; overflow-y: auto;">
            <button class="dropdown-item" 
                    *ngFor="let estudiante of estudiantesFiltrados"
                    (click)="seleccionarEstudiante(estudiante)">
              <div class="d-flex justify-content-between">
                <span>{{ estudiante.email }}</span>
                <small class="text-muted">{{ estudiante.name }}</small>
              </div>
            </button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre del alumno</label>
        <input type="text" id="nombre" class="form-control" 
               [(ngModel)]="nombre" name="nombre"
               [readonly]="usuarioActual?.tipoUsuario === 'profesor' && nombre !== ''"
               placeholder="Nombre del estudiante">
        <div class="form-text" *ngIf="usuarioActual?.tipoUsuario === 'profesor'">
          El nombre se completará automáticamente al seleccionar un correo de estudiante
        </div>
      </div>

      <div class="mb-3">
        <label for="materia" class="form-label">Materia</label>
        <div class="position-relative">
          <input type="text" id="materia" class="form-control" 
                 [(ngModel)]="materia" name="materia"
                 (input)="onMateriaInput($event)"
                 (blur)="ocultarSugerenciasMaterias()"
                 placeholder="Escribe el nombre de la materia..."
                 autocomplete="off">
          
          <!-- Dropdown de sugerencias de materias -->
          <div class="dropdown-menu show position-absolute w-100" 
               *ngIf="mostrarSugerenciasMaterias && materiasFiltradas.length > 0"
               style="z-index: 1050; max-height: 200px; overflow-y: auto;">
            <button class="dropdown-item" 
                    *ngFor="let materiaSug of materiasFiltradas"
                    (click)="seleccionarMateria(materiaSug)">
              {{ materiaSug }}
            </button>
          </div>
        </div>
        
        <!-- Tareas previas de la materia seleccionada -->
        <div *ngIf="mostrarTareasPrevias && tareasPreviasDisponibles.length > 0" class="mt-2">
          <div class="alert alert-info">
            <h6 class="mb-2">
              <i class="bi bi-lightbulb me-1"></i>
              Tareas previas de "{{ materia }}":
            </h6>
            <div class="d-flex flex-wrap gap-1">
              <button class="btn btn-sm btn-outline-primary" 
                      *ngFor="let tareaPrev of tareasPreviasDisponibles"
                      (click)="agregarTareaPreviaAlFormulario(tareaPrev)"
                      title="Click para agregar esta tarea al formulario">
                <i class="bi bi-plus-circle me-1"></i>{{ tareaPrev.titulo }}
              </button>
            </div>
            <button class="btn btn-sm btn-outline-secondary mt-2" 
                    (click)="ocultarTareasPrevias()">
              Ocultar sugerencias
            </button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="tipo" class="form-label">Tipo de evaluación</label>
        <select id="tipo" class="form-select" [(ngModel)]="tipo" name="tipo" (change)="onTipoChange()">
          <option value="tareas" selected>Solo tareas</option>
          <option value="tareas_examen">Tareas + Examen</option>
          <option value="examen">Solo examen</option>
        </select>
        
        <!-- Alerta de evaluación existente -->
        <div *ngIf="evaluacionExistenteInfo && !modoEdicion" class="alert alert-warning mt-2">
          <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div class="flex-grow-1">
              <strong>¡Evaluación existente encontrada!</strong><br>
              <small>
                Ya tienes una evaluación de "{{ evaluacionExistenteInfo.materia }}" ({{ getTipoDisplay(evaluacionExistenteInfo.tipo) }}) 
                con promedio <span [ngClass]="getPromedioClass(evaluacionExistenteInfo.promedio)">{{ evaluacionExistenteInfo.promedio.toFixed(2) }}</span>.
                <br>Al evaluar, se te preguntará si quieres actualizar la existente o crear una nueva.
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Campo de ponderación solo para tareas + examen -->
      <div class="mb-3" *ngIf="tipo === 'tareas_examen'">
        <label for="ponderacion" class="form-label">Ponderación de tareas (valor entre 0 y 1)</label>
        <input type="number" id="ponderacion" class="form-control" 
               [(ngModel)]="ponderacionTareas" name="ponderacion" 
               min="0" max="1" step="0.1" 
               [disabled]="!calificacionesHabilitadas">
        <div class="form-text">Ejemplo: 0.4 significa 40% tareas y 60% examen.</div>
      </div>

      <!-- Tareas dinámicas -->
      <div class="mb-3" *ngIf="tipo === 'tareas' || tipo === 'tareas_examen'">
        <label class="form-label">Tareas</label>
        <div class="form-text mb-2">
          Completa el campo de calificación y presiona Enter para generar la siguiente tarea. 
          <strong>Cada tarea puede tener su propia ponderación individual</strong> (peso en el promedio final). 
          Las ponderaciones se normalizarán automáticamente. Campos vacíos no se consideran en el cálculo.
        </div>

        <div *ngFor="let cal of calificaciones; let i = index; trackBy: trackByIndex" class="card mb-3">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Tarea {{i + 1}}</h6>
              <button class="btn btn-outline-danger btn-sm" type="button" 
                      (click)="eliminarCalificacion(i)" 
                      [disabled]="!calificacionesHabilitadas || calificaciones.length === 1">✖</button>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">Título de la tarea</label>
                <input type="text" class="form-control" [(ngModel)]="titulosTareas[i]" 
                       name="titulo{{i}}" placeholder="Título de la tarea"
                       [disabled]="!calificacionesHabilitadas">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">Fecha de entrega</label>
                <input type="date" class="form-control" [(ngModel)]="fechasTareas[i]" 
                       name="fecha{{i}}"
                       [disabled]="!calificacionesHabilitadas">
              </div>
              <div class="col-12 mb-2">
                <label class="form-label">Descripción</label>
                <textarea class="form-control" rows="2" [(ngModel)]="descripcionesTareas[i]" 
                          name="descripcion{{i}}" placeholder="Descripción de la tarea"
                          [disabled]="!calificacionesHabilitadas"></textarea>
              </div>
              <div class="col-md-6">
                <label for="ponderacion{{i}}" class="form-label">Ponderación</label>
                <input type="number" class="form-control" [(ngModel)]="ponderacionesTareas[i]" 
                       name="ponderacion{{i}}" min="0" max="1" step="0.01"
                       [disabled]="!calificacionesHabilitadas"
                       placeholder="Ej: 0.3 (30%)">
                <div class="form-text">Peso de esta tarea en el promedio final</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Calificación</label>
                <input type="number" class="form-control" 
                       #calInput{{i}}
                       [value]="calificaciones[i] || ''"
                       min="0" max="10" step="0.1" name="cal{{i}}" 
                       placeholder="Calificación (opcional)"
                       (keyup)="onCalificacionKeyUp(i, $event)"
                       (blur)="onCalificacionBlur(i, $event)"
                       [disabled]="!calificacionesHabilitadas">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resumen de ponderaciones -->
        <div class="alert alert-info mt-2" *ngIf="ponderacionesTareas.length > 0">
          <div class="d-flex justify-content-between align-items-center">
            <small>
              <i class="bi bi-info-circle me-1"></i>
              <strong>Suma total de ponderaciones:</strong> 
              {{ getSumaPonderaciones().toFixed(2) }}
            </small>
            <button class="btn btn-sm btn-outline-primary" 
                    type="button" 
                    (click)="normalizarPonderaciones()"
                    [disabled]="!calificacionesHabilitadas">
              <i class="bi bi-arrow-clockwise me-1"></i>Normalizar
            </button>
          </div>
          <small class="text-muted">
            Las ponderaciones se normalizarán automáticamente al evaluar para que sumen 1.0 (100%)
          </small>
        </div>
      </div>


      <!-- Campos dinámicos para exámenes -->
      <div class="mb-3" *ngIf="tipo === 'tareas_examen' || tipo === 'examen'">
        <label class="form-label">Calificaciones de exámenes</label>
        <div class="form-text mb-2">Puedes agregar varios exámenes. Campos vacíos no se consideran en el cálculo.</div>
        <div *ngFor="let ex of calExamenes; let j = index; trackBy: trackByIndex" class="input-group mb-2">
          <input type="number" class="form-control" 
                 #exInput{{j}}
                 [value]="calExamenes[j] || ''"
                 min="0" max="10" step="0.1" name="examen{{j}}"
                 placeholder="Calificación Examen {{j + 1}} (opcional)"
                 (keyup)="onExamenKeyUp(j, $event)"
                 (blur)="onExamenBlur(j, $event)"
                 [disabled]="!calificacionesHabilitadas">
          <button class="btn btn-outline-danger" type="button"
                  (click)="eliminarExamen(j)"
                  [disabled]="!calificacionesHabilitadas || calExamenes.length === 1">✖</button>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-success" 
                (click)="modoEdicion ? actualizarEvaluacion() : evaluar()" 
                [disabled]="!calificacionesHabilitadas">
          {{ modoEdicion ? 'Actualizar Evaluación' : 'Evaluar' }}
        </button>
        
        <button *ngIf="modoEdicion" class="btn btn-secondary" 
                (click)="cancelarEdicion()">
          Cancelar
        </button>
      </div>

      <div class="mt-3" *ngIf="mostrarResultado">
        <div class="alert" [ngClass]="resultadoClase">
          {{ resultadoTexto }}
        </div>
      </div>
    </div>

    <!-- Lado Derecho: Gráfica y Historial -->
    <div class="col-md-6">
      <h4>Historial de Promedios</h4>
      <div class="border rounded p-3 bg-light mb-4" style="min-height: 320px; max-width: 100%; display: flex; align-items: center; justify-content: center;">
        <canvas baseChart
                [data]="barChartData"
                [options]="barChartOptions"
                [legend]="barChartLegend"
                [type]="barChartType"
                style="max-height: 250px; width: 100%;">
        </canvas>
      </div>
      
      <!-- Leyenda de la gráfica -->
      <div class="alert alert-info mb-4" *ngIf="usuarioLogueado">
        <div class="d-flex align-items-center">
          <i class="bi bi-info-circle me-2"></i>
          <small>
            <strong>Leyenda:</strong> 
            <span class="badge bg-primary me-1">Azul</span> Solo tareas, 
            <span class="badge bg-warning text-dark me-1">Amarillo</span> Tareas + Examen, 
            <span class="badge bg-danger me-1">Rojo</span> Solo examen
            <br>
            <span class="badge bg-danger me-1 mt-1">Rojo Intenso</span> Grupos o estudiantes con reprobados (promedio < 6.0)
            <ng-container *ngIf="usuarioActual?.tipoUsuario === 'profesor'">
              <br><small class="text-muted mt-1 d-block">Los profesores ven promedios generales por grupo. Pasa el cursor sobre las barras para ver detalles y nombres de estudiantes reprobados.</small>
            </ng-container>
          </small>
        </div>
      </div>

      <!-- Tabla de historial de evaluaciones solo si usuario está logueado -->
      <div class="border rounded p-3 bg-white">
        <ng-container *ngIf="usuarioLogueado; else noLoginMsg">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Historial de Evaluaciones</h5>
          </div>
          
          <!-- Vista agrupada para profesores -->
          <div *ngIf="mostrarVistaAgrupada(); else vistaIndividual">
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle me-2"></i>
              <small>Vista agrupada por materia y tipo de evaluación. Expandir para ver evaluaciones individuales.</small>
            </div>
            
            <div class="accordion" id="historialAgrupadoAccordion">
              <div class="accordion-item" *ngFor="let key of getHistorialAgrupadoKeys(); let i = index">
                <h2 class="accordion-header" [id]="'headingGroup' + i">
                  <button class="accordion-button collapsed" type="button" 
                          data-bs-toggle="collapse" 
                          [attr.data-bs-target]="'#collapseGroup' + i" 
                          [attr.aria-expanded]="false" 
                          [attr.aria-controls]="'collapseGroup' + i">
                    <div class="w-100">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <strong>{{ historialAgrupado[key].materia }}</strong>
                          <br>
                          <small class="text-muted">{{ getTipoDisplay(historialAgrupado[key].tipo) }} • {{ historialAgrupado[key].totalEstudiantes }} estudiante(s)</small>
                        </div>
                        <div class="text-end">
                          <span [ngClass]="getPromedioClass(historialAgrupado[key].promedioGeneral)" class="fs-5">
                            {{ historialAgrupado[key].promedioGeneral.toFixed(2) }}
                          </span>
                          <br>
                          <small class="text-muted">Promedio General</small>
                        </div>
                      </div>
                    </div>
                  </button>
                </h2>
                <div [id]="'collapseGroup' + i" class="accordion-collapse collapse" 
                     [attr.aria-labelledby]="'headingGroup' + i" 
                     data-bs-parent="#historialAgrupadoAccordion">
                  <div class="accordion-body">
                    <!-- Evaluaciones individuales dentro del grupo -->
                    <div class="row">
                      <div class="col-12 mb-2">
                        <h6 class="text-primary mb-3">
                          <i class="bi bi-people me-1"></i>Evaluaciones Individuales:
                        </h6>
                      </div>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-6 mb-3" *ngFor="let evaluacion of historialAgrupado[key].evaluaciones">
                        <div class="card">
                          <div class="card-header py-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <strong class="text-truncate">{{ evaluacion.nombre }}</strong>
                              <span [ngClass]="getPromedioClass(evaluacion.promedio)" class="fw-bold">
                                {{ evaluacion.promedio.toFixed(2) }}
                              </span>
                            </div>
                            <small class="text-muted">{{ evaluacion.fecha | date:'short' }}</small>
                          </div>
                          <div class="card-body p-2">
                            
                            <!-- Detalles de tareas -->
                            <div *ngIf="evaluacion.tareas && evaluacion.tareas.length > 0" class="mb-2">
                              <h6 class="small text-primary mb-1">
                                <i class="bi bi-clipboard-check me-1"></i>Tareas:
                              </h6>
                              <div class="small">
                                <div class="d-flex justify-content-between" *ngFor="let tarea of evaluacion.tareas">
                                  <span class="text-truncate">{{ tarea.titulo || 'Sin título' }}</span>
                                  <span class="badge bg-primary">{{ tarea.calificacion }}</span>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Detalles de exámenes -->
                            <div *ngIf="evaluacion.examenes && evaluacion.examenes.length > 0" class="mb-2">
                              <h6 class="small text-warning mb-1">
                                <i class="bi bi-file-earmark-text me-1"></i>Exámenes:
                              </h6>
                              <div class="d-flex flex-wrap gap-1">
                                <span class="badge bg-warning text-dark small" *ngFor="let examen of evaluacion.examenes; let j = index">
                                  {{ examen }}
                                </span>
                              </div>
                            </div>
                            
                            <!-- Resultado final -->
                            <div class="border-top pt-1 mt-2">
                              <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Estado:</small>
                                <small [ngClass]="getPromedioClass(evaluacion.promedio)">
                                  {{ evaluacion.promedio >= 6 ? 'Aprobado' : 'Reprobado' }}
                                </small>
                              </div>
                            </div>
                            
                            <!-- Botones de acción -->
                            <div class="d-flex gap-1 mt-2">
                              <button class="btn btn-sm btn-outline-primary flex-fill" (click)="editarEvaluacion(evaluacion)">
                                <i class="bi bi-pencil"></i>
                              </button>
                              <button class="btn btn-sm btn-outline-danger flex-fill" (click)="eliminarEvaluacion(evaluacion.id)">
                                <i class="bi bi-trash"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Vista individual (para estudiantes o cuando no hay datos agrupados) -->
          <ng-template #vistaIndividual>
            <div class="accordion" id="historialAccordion" *ngIf="historial && historial.length > 0">
              <div class="accordion-item" *ngFor="let item of historial; let i = index">
                <h2 class="accordion-header" [id]="'heading' + i">
                <button class="accordion-button collapsed" type="button" 
                        data-bs-toggle="collapse" 
                        [attr.data-bs-target]="'#collapse' + i" 
                        [attr.aria-expanded]="false" 
                        [attr.aria-controls]="'collapse' + i">
                  <div class="w-100">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <strong>{{ item.materia }}</strong>
                        <span *ngIf="usuarioActual?.tipoUsuario==='profesor'"> - {{ item.nombre }}</span>
                        <br>
                        <small class="text-muted">
                          {{ item.fecha | date:'short' }} | {{ getTipoDisplay(item.tipo) }}
                        </small>
                      </div>
                      <div class="text-end">
                        <span [ngClass]="getPromedioClass(item.promedio)" class="fs-5">
                          {{ item.promedio.toFixed(2) }}
                        </span>
                      </div>
                    </div>
                  </div>
                </button>
              </h2>
              <div [id]="'collapse' + i" class="accordion-collapse collapse" 
                   [attr.aria-labelledby]="'heading' + i" 
                   data-bs-parent="#historialAccordion">
                <div class="accordion-body">
                  <!-- Detalles de tareas -->
                  <div *ngIf="item.tareas && item.tareas.length > 0" class="mb-3">
                    <h6 class="text-primary mb-2">
                      <i class="bi bi-clipboard-check me-1"></i>Tareas:
                    </h6>
                    <div class="row">
                      <div class="col-md-6" *ngFor="let tarea of item.tareas">
                        <div class="card card-sm mb-2">
                          <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                              <div class="flex-grow-1">
                                <h6 class="card-title mb-1 text-truncate">{{ tarea.titulo || 'Sin título' }}</h6>
                                <small class="text-muted" *ngIf="tarea.fecha">
                                  <i class="bi bi-calendar3 me-1"></i>{{ tarea.fecha }}
                                </small>
                                <p class="card-text small mb-0" *ngIf="tarea.descripcion">{{ tarea.descripcion }}</p>
                              </div>
                              <div class="text-end ms-2">
                                <span class="badge bg-primary fs-6">{{ tarea.calificacion }}</span>
                                <small class="text-muted d-block" *ngIf="tarea.ponderacion">
                                  Peso: {{ (tarea.ponderacion * 100).toFixed(1) }}%
                                </small>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Detalles de exámenes -->
                  <div *ngIf="item.examenes && item.examenes.length > 0" class="mb-3">
                    <h6 class="text-warning mb-2">
                      <i class="bi bi-file-earmark-text me-1"></i>Exámenes:
                    </h6>
                    <div class="d-flex flex-wrap gap-2">
                      <span class="badge bg-warning text-dark fs-6" *ngFor="let examen of item.examenes; let j = index">
                        Examen {{ j + 1 }}: {{ examen }}
                      </span>
                    </div>
                  </div>
                  
                  <!-- Ponderación para tipo mixto -->
                  <div *ngIf="item.tipo === 'tareas_examen' && item.ponderacionTareas !== undefined" class="mb-3">
                    <h6 class="text-info mb-1">
                      <i class="bi bi-bar-chart me-1"></i>Ponderación:
                    </h6>
                    <small class="text-muted">
                      Tareas: {{ (item.ponderacionTareas * 100).toFixed(0) }}% | 
                      Exámenes: {{ ((1 - item.ponderacionTareas) * 100).toFixed(0) }}%
                    </small>
                  </div>
                  
                  <!-- Resultado final -->
                  <div class="border-top pt-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="text-muted">Resultado:</span>
                      <span [ngClass]="getPromedioClass(item.promedio)">
                        <strong>{{ item.resultado }}</strong>
                      </span>
                    </div>
                  </div>
                  
                  <!-- Botones de acción -->
                  <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-sm btn-outline-primary" (click)="editarEvaluacion(item)">
                      <i class="bi bi-pencil me-1"></i>Editar
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="eliminarEvaluacion(item.id)">
                      <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </ng-template>
          
          <!-- Mensaje cuando no hay historial -->
          <div class="alert alert-info text-center mb-0" *ngIf="!historial || historial.length === 0">
            <i class="bi bi-info-circle me-2"></i>
            No hay evaluaciones registradas aún.
          </div>
        </ng-container>
        <ng-template #noLoginMsg>
          <div class="alert alert-info text-center mb-0 login-prompt" 
               (click)="irALogin()">
            <i class="bi bi-box-arrow-in-right me-2"></i>
            Haz clic aquí para iniciar sesión y ver el historial de evaluaciones.
          </div>
        </ng-template>
      </div>
    </div>
</div>
